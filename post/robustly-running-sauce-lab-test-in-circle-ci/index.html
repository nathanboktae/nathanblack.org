<!DOCTYPE html><html><head><title>A fast and robust way to run Sauce Labs tests in Circle CI - Nathan Black</title><meta charset="utf-8"><meta name="description" content="A blog about modern web development, from front end to Node.js, JavaScript, styling, testing, and software development practices"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" href="/site.021b7ad.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400|Raleway|Nobile:400,700"></head><body><header><aside><a href="https://github.com/nathanboktae" class="github"></a><a href="https://plus.google.com/+NathanBlackJ" class="gplus"></a><a href="mailto:nathan@nathanblack.org" class="email"></a></aside><div class="logo"><img src="//gravatar.com/avatar/f78c2c988486648311bcf116070e2487.jpg?s=110"></div><h2><a href="/"><span class="name">nathanblack</span><span>.org</span></a></h2><h4>Refining Modern Web Development</h4></header><aside class="github"><h2><a href="https://github.com/nathanboktae"><b>@</b>nathanboktae</a></h2><ul data-bind="foreach: events" class="events"><li data-bind="attr: { class: type }"><span data-bind="text: when" class="date"></span><h3 data-bind="html: summary"></h3><p data-bind="text: $data.details"></p></li></ul></aside><article><span class="date">Thursday, September 17th 2015</span><section class="post"><h1>A fast and robust way to run Sauce Labs tests in Circle CI</h1><div class="content"><p>We&#39;ve been using <a href="https://circleci.com">Circle CI</a> at <a href="http://www.appuri.com">Appuri</a> for many months now and have been very happy with it. It&#39;s very simple and has a great breadth of features, namely the ability to SSH into a build to diagnose it when things get really tricky, as well as docker build services, slack integration, and lots of built-in services. After I hit a wall with <a href="http://phantomjs.org">PhantomJS</a>, and needing to run our tests on multiple browsers anyways, it was time to integrate <a href="">Sauce Labs</a> to do our browser testing, which I&#39;ve had great experience with on <a href="https://github.com/nathanboktae/cherrytree-for-knockout">many</a> <a href="https://github.com/nathanboktae/frypan-knockout-grid">open source</a> <a href="https://github.com/nathanboktae/knockout-choose">projects</a>. In those projects I used <a href="https://github.com/axemclion/grunt-saucelabs">grunt-saucelabs</a> as I am not a big fan of Karma as I like to control the HTML page the tests run on as well as the simplicity of <a href="https://github.com/nathanboktae/mocha-phantomjs">mocha-phantomjs</a> and just refreshing a flat file or using <a href="http://www.browsersync.io/">browser sync</a>.</p>
<p>However we&#39;re using <a href="http://gulpjs.com/">gulp</a> and I didn&#39;t want to pull in <a href="http://gruntjs.com/">grunt</a> and have two build systems. Unfortunately there&#39;s no <code>gulp-saucelabs</code>, which I contemplated doing (I may sometime), but I found I could simply use <a href="https://github.com/nathanboktae/mocha-cloud">mocha-cloud</a>. However, it didn&#39;t bring up the tunnel.</p>
<!--more-->
<p>Circle has some <a href="https://circleci.com/docs/browser-testing-with-sauce-labs">brief documentation</a> on how to connect the tunnel - they don&#39;t include <a href="http://saucelabs.com/connect">Sauce Connect</a> so you have to <code>wget</code> it yourself every time. No problem. However looking at the test section:</p>
<pre><code><span class="hljs-keyword">test:
  </span>override:
    - cd sc-*-linux &amp;&amp; ./bin/sc -u $SAUCE_USERNAME -k $SAUCE_ACCESS_KEY:
        background: true
    - python -m hello.hello_app:
        background: true
    - sleep 60
    - nosetests
</code></pre><p>Whoa did you see that? A one minute sleep! Yikes! The sauce labs tunnel does take some time to setup, usually 20-30 seconds in my experience. Random sleeps are the worst for stable builds.... There must be a better way, and there is.</p>
<p>First off, even though they recommend getting the binary in the post dependencies section, they don&#39;t start the tunnel right away, even though it&#39;s running in the background. Start that sucker ASAP!</p>
<pre><code class="lang-yaml">dependencies:
  pre:
    -<span class="ruby"> wget <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/saucelabs.com/downloads</span><span class="hljs-regexp">/sc-latest-linux.tar.gz
</span></span>    -<span class="ruby"><span class="hljs-regexp"> tar -xzf sc-latest-linux.tar.gz
</span></span>    -<span class="ruby"><span class="hljs-regexp"> cd sc-*-linux &amp;&amp; ./bin</span><span class="hljs-regexp">/sc:
</span></span>        background: true
</code></pre>
<p>Now the tunnel is connecting while you fetch your code from github and pull down your npm, python, go, whatever dependant packages. </p>
<p>When creating the tunnel, they say to wait for &quot;you may start your tests&quot; before starting tests. We could tail the output and check for that string, but I noticed something right before it</p>
<pre><code><span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">44</span> - Starting up; pid <span class="hljs-number">7002</span>
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">44</span> - Command <span class="hljs-keyword">line</span> arguments: sc
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">44</span> - <span class="hljs-keyword">Using</span> no proxy <span class="hljs-keyword">for</span> connecting <span class="hljs-keyword">to</span> Sauce Labs REST API.
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">44</span> - Resolving saucelabs.<span class="hljs-keyword">com</span> <span class="hljs-keyword">to</span> <span class="hljs-number">162.222.73.28</span> took <span class="hljs-number">37</span> ms.
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">44</span> - Started scproxy <span class="hljs-keyword">on</span> port <span class="hljs-number">59124.</span>
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">44</span> - Please <span class="hljs-keyword">wait</span> <span class="hljs-keyword">for</span> <span class="hljs-comment">'you may start your tests' to start your tests.</span>
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">44</span> - Starting secure <span class="hljs-comment">remote tunnel VM...</span>
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">52</span> - Secure <span class="hljs-comment">remote tunnel VM provisioned.</span>
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">52</span> - Tunnel ID: xxxxxxx
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">53</span> - Secure <span class="hljs-comment">remote tunnel VM is now: booting</span>
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">58</span> - Secure <span class="hljs-comment">remote tunnel VM is now: running</span>
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">58</span> - <span class="hljs-comment">Remote tunnel host is: makiXXXXX.miso.saucelabs.com</span>
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">58</span> - <span class="hljs-keyword">Using</span> no proxy <span class="hljs-keyword">for</span> connecting <span class="hljs-keyword">to</span> tunnel VM.
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">58</span> - Resolving makiXXXXX.miso.saucelabs.<span class="hljs-keyword">com</span> <span class="hljs-keyword">to</span> <span class="hljs-number">162.222.77.201</span> took <span class="hljs-number">53</span> ms.
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">58</span> - Starting Selenium listener...
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">58</span> - Establishing secure TLS connection <span class="hljs-keyword">to</span> tunnel...
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">58</span> - Selenium listener started <span class="hljs-keyword">on</span> port <span class="hljs-number">4445.</span>
<span class="hljs-symbol">17 </span>Sep <span class="hljs-number">21</span>:<span class="hljs-number">59</span>:<span class="hljs-number">59</span> - Sauce Connect is up, you may start your tests.
</code></pre><p>It listens to port <code>4445</code> right before you can start the tests. Turns out we can poll for that port being listened on, then we start our tests!</p>
<pre><code class="lang-yaml">dependencies:
  pre:
    - wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    - tar -xzf sc-latest-linux.tar.gz
    - cd sc-*-linux &amp;&amp; ./bin/sc:
        background: true

<span class="hljs-keyword">test:
  </span>pre:
    - "while ! lsof -i:4445 -t; do sleep 3; done"
</code></pre>
<p>A reliable build that doesn&#39;t have a dead one minute wait.</p>
</div><ul class="tags"><li><a href="/tag/continuous-integration">continuous-integration</a></li><li><a href="/tag/testing">testing</a></li><li><a href="/tag/front-end">front-end</a></li><li><a href="/tag/sauce-labs">sauce-labs</a></li><li><a href="/tag/circle-ci">circle-ci</a></li></ul></section></article><script src="/site.021b7ad.js"></script></body></html>